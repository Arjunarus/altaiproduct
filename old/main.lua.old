
game._brokenpc = 0; --номер сломаного компа

-- триггеры квестов, включаются по ходу игры, динамически
game._mainquest = false; -- главный мега-квест
game._pcfixing = false; -- мини-квест "починка компа"

badpcdlg = dlg{
	nam = 'сломался комп',
	dsc = function()
		--mobile._calling=false;
		return 'Я снял трубку. Это звонят из кабинета '..game._brokenpc..'.';
	end,
	obj={
		[1] = phr('Алло!','Алло! Это системный администратор?',[[pon(2,3)]]),
		[2] = _phr('Да, что-то случилось?','У нас сломался компьютер.',[[pon(4);poff(3)]]),
		[3] = _phr('Нет, вы позвонили в администрацию президента.','Передайте президенту, что у нас сломался компьютер.',[[pon(4);poff(2)]]),
		[4] = _phr('Замечательно, а что с ним?','Что-то не работет - придите сами посмотрите.','pon(5)'),
		[5] = _phr('Хорошо, я подойду как освобожусь.'),
	},
	exit = function()
		lifeon('mobile');
		return 'Отлично, теперь еще и комп чинить :(';
	end,
};

mainquestdlg = dlg{
	nam = 'главный квест',
	dsc = 'Это звонит директор!',
	obj = {
		[1] = phr('Алло! Я слушаю.','Алексей! Зайди ко мне!','pon(2)'),
		[2] = _phr('Хорошо, сейчас приду.'),
	},
	exit = function()
		lifeon('mobile');
		return 'Интересно что же такого случилось...';
	end,
};

mobile = obj{
	r=1;
	--game._brokenpc=0;
	_calling=false;
	_state=0; --состояние 
	nam = 'мобильник',
	inv = function(s)
		if s._calling then
			lifeoff('mobile');
			s._calling=false;
			if s._state==1 then
				local num=rnd(8);
				if num==1 then kab1.obj:add('badpc') end;
				if num==2 then kab2.obj:add('badpc') end;
				if num==3 then kab3.obj:add('badpc') end;
				if num==4 then kab4.obj:add('badpc') end;
				if num==5 then kab5.obj:add('badpc') end;
				if num==6 then kab6.obj:add('badpc') end;
				if num==7 then kab7.obj:add('badpc') end;
				if num==8 then kab8.obj:add('badpc') end;
				game._brokenpc = num;
				game._pcfixing = true; -- включаем квест поломки компа
				return walkin('badpcdlg');
			end;
			
			if s._state==2 then
				game._mainquest=true; -- включим главный мега-квест 
				walkin(mainquestdlg);
				return;
			end;
			
			if s._state==3 then
				game._weatherquest=true; -- включаем мини-квест с погодой через 50 ходов
				walkin(mainquestdlg);
				return;
			end;
			
			
			return 'Состояние: '..s._state;
		else
			return 'Это мой мобильник Motorolla C650, старенький, такие сейчас не в моде.';		
		end;
	end,
	life = function(s)
		r=r+1;
		if r==3 then --должно быть 3, 0 для отладки
			s._calling=true;
			s._state=2;
		end;
		if r==50 then 
			s._calling=true;
			s._state=3;
		end;
		if r==10 then 
			game._eatingquest = true;
		end;
		
		local rn=rnd(30); --потом проверить возможность одновременного срабатывания рэндома и счетчика
		if rn==15 and not game._pcfixing and not s._calling then
			s._calling=true;
			s._state=1;		
		end;
		
		if s._calling then
			return 'У меня звонит мобильник!';
		else 
			if game._eatingquest and r%2==0 then return 'Что-то я проголодался, надо бы поесть...';
			else return;
			end;
		end;
	end,
};

badpc = obj{
	nam = 'сломаный комп',
	dsc = 'Вам показали на сломаный {комп} в кабинете.',
	
};

inv():add('mobile');
lifeon('mobile');

